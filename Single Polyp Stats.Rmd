---
title: "Single Polyp Stats"
author: "Shayle Matsuda"
date: "10/28/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---
PERMANOVA for single polyp metabolomics

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# libraries
```{r}  
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
library(ape)

library(plyr) 
library(dplyr)
library(ggplot2)
library(ggpubr)
library(lmerTest)
library(car)
library(emmeans)
library(gridExtra)
library(multcomp)
library(reshape)
library(tidyverse)
library(factoextra)
library(reshape2)
library(vegan) 
library(pairwiseAdonis)
library("scales")
packageVersion("scales")
library(RColorBrewer)
library(colorRamps)
library(devtools)
library(phyloseq)
library(readr)
library(microbiome)
library(vegan)
```

Load in data:
```{r}
mData<-read.csv("single polyp master with PCoA coordinates.csv") #metabolomics data and xy coords from Ty
mData$ATTRIBUTE_Sample_Name<-as.factor(as.character(mData$ATTRIBUTE_Sample_Name))
mData$ATTRIBUTE_Colony_number<-as.factor(as.character(mData$ATTRIBUTE_Colony_number))


```

PERMANOVA
```{r}
#PERMANOVA

#sep dfs
mData.sd<-mData[,1:11] #metadata
mData.meta<-mData[,12:566] #metabolomics data
mData.PCoA<-mData[,567:568]

#PERMANOVA on Ty's PCoA data
#adonis
adonis(mData.PCoA~ATTRIBUTE_Colony_number, data=mData.sd)

#warning due to neg values
#                         Df SumsOfSqs MeanSqs F.Model      R2 Pr(>F)    
#ATTRIBUTE_Colony_number  18 126802909 7044606  157433 0.99988  0.001 ***
#Residuals               341     15259      45         0.00012           
#Total                   359 126818168                 1.00000           



#######################

#remake Matrix myself:
# Bray-Curtis distance metric
mData.dist <- vegdist(mData.meta,  method = "bray")

PCOA <- pcoa(mData.dist) #pcoa
barplot(PCOA$values$Relative_eig[1:10]) # plot the eigenvalues 
biplot.pcoa(PCOA) #plot

PCOAaxes <- PCOA$vectors[,c(1,2)]


#Between COLONIES
adonis(PCOAaxes~ATTRIBUTE_Colony_number, data=mData.sd)

#                          Df SumsOfSqs MeanSqs F.Model      R2 Pr(>F)    
# ATTRIBUTE_Colony_number  18 174309128 9683840  173067 0.99989  0.001 ***
# Residuals               341     19080      56         0.00011           
# Total                   359 174328208                 1.00000           



#Between Sampling area ###########################
adonis(PCOAaxes~Area, data=mData.sd)
#            Df SumsOfSqs  MeanSqs F.Model      R2 Pr(>F)  
# Area        5 174133186 34826637   63217 0.99888  0.031 *
# Residuals 354    195022      551         0.00112         
# Total     359 174328208                  1.00000         

#Between polyps 1-3 only ###########################
#subset data

mData.PCOAaxesSD<-merge(mData.sd,PCOAaxes,by=0, all=TRUE) #merge PCOAaxes and metadata

mData.Polyps<-subset(mData.PCOAaxesSD, Area=="Base"|Area=="Touching 1"|Area=="Touching 2") #polyps 1-3 only
mData.Polyps.sd<-mData.Polyps[,1:12]
PCOAaxes.polyps <- mData.Polyps[,c(13,14)]

adonis(PCOAaxes.polyps~Area, data=mData.Polyps.sd)
#            Df SumsOfSqs MeanSqs F.Model      R2 Pr(>F)
# Area        2      9558  4778.8  6.7456 0.07082  0.467
# Residuals 177    125392   708.4         0.92918       
# Total     179    134950                 1.00000       

#Between Branches by colony ###########################
#subset data
mData.PCOAaxesSD<-merge(mData.sd,PCOAaxes,by=0, all=TRUE) #merge PCOAaxes and metadata

#colony 945
mData.Branch945<-subset(mData.PCOAaxesSD, ATTRIBUTE_Colony_number=="945") 
mData.Branch945.sd<-mData.Branch945[,1:12]
PCOAaxes.Branch945 <- mData.Branch945[,c(13,14)]

adonis(PCOAaxes.Branch945~ATTRIBUTE_Branch_Letter, data=mData.Branch945.sd)
#                         Df SumsOfSqs MeanSqs F.Model      R2 Pr(>F)  
# ATTRIBUTE_Branch_Letter  2   1317.88  658.94   361.7 0.97969  0.063 .
# Residuals               15     27.33    1.82         0.02031         
# Total                   17   1345.21                 1.00000              

```

